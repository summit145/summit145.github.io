<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sledders 3D Pixel â€“ Ultimate Freeride</title>
<style>
html, body { margin:0; padding:0; background:#0b1622; overflow:hidden; }
canvas { display:block; margin:auto; image-rendering:pixelated; }
</style>
</head>
<body>
<canvas id="game" width="480" height="270"></canvas>
<script>
/* ================= CONFIG ================= */
const SCALE = 3;
const canvas = document.getElementById("game");
canvas.style.width = canvas.width * SCALE + "px";
canvas.style.height = canvas.height * SCALE + "px";
const ctx = canvas.getContext("2d");

const WORLD_SIZE = 2000;
const GRID = 16;
let timeOfDay = 0;
const keys = {};
onkeydown = e => keys[e.key] = true;
onkeyup = e => keys[e.key] = false;

/* ================= TERRAIN ================= */
const terrain = [];
for(let x=0;x<WORLD_SIZE/GRID;x++){
    terrain[x]=[];
    for(let y=0;y<WORLD_SIZE/GRID;y++){
        const mx = Math.sin(x/12)*50 + Math.cos(y/14)*50;
        const noise = Math.random()*20;
        terrain[x][y] = mx + noise;
    }
}

/* ================= TREES ================= */
const trees=[];
for(let i=0;i<300;i++){
    trees.push({
        x:Math.random()*WORLD_SIZE,
        y:Math.random()*WORLD_SIZE,
        h:6+Math.random()*6,
        color:`rgb(${30+Math.random()*50},${80+Math.random()*60},${20+Math.random()*40})`,
        snowCap: Math.random()<0.6
    });
}

/* ================= PLAYER ================= */
const player = {
    x: WORLD_SIZE/2,
    y: WORLD_SIZE/2,
    z:0,
    angle:0,
    speed:0,
    lean:0,
    width:8,
    height:12
};

/* ================= SNOW & PARTICLES ================= */
const snowflakes=[];
for(let i=0;i<300;i++){
    snowflakes.push({
        x: Math.random()*canvas.width,
        y: Math.random()*canvas.height,
        dy: 0.2 + Math.random()*0.3,
        dx: (Math.random()*0.2-0.1),
        size: 1 + Math.random()*1
    });
}

const powder = [];

/* ================= HELPER FUNCTIONS ================= */
function getTerrainHeight(x,y){
    const gx=Math.floor(x/GRID);
    const gy=Math.floor(y/GRID);
    if(terrain[gx] && terrain[gx][gy]!==undefined) return terrain[gx][gy];
    return 0;
}

function getSlope(x,y){
    const gx=Math.floor(x/GRID);
    const gy=Math.floor(y/GRID);
    if(terrain[gx] && terrain[gx][gy]!==undefined){
        const h = terrain[gx][gy];
        const hx = terrain[gx+1]?terrain[gx+1][gy]:h;
        const hy = terrain[gx][gy+1]!==undefined?terrain[gx][gy+1]:h;
        return {dx:hx-h, dy:hy-h};
    }
    return {dx:0, dy:0};
}

/* ================= UPDATE ================= */
function update(){
    timeOfDay += 0.0003;

    // Controls
    if(keys["w"] || keys["ArrowUp"]) player.speed += 0.15;
    if(keys["s"] || keys["ArrowDown"]) player.speed *= 0.9;
    if(keys["a"] || keys["ArrowLeft"]) player.angle -= 0.05;
    if(keys["d"] || keys["ArrowRight"]) player.angle += 0.05;

    // Friction & max speed
    player.speed *= 0.985;
    player.speed = Math.max(Math.min(player.speed,5),-2);

    // Terrain slope
    const slope = getSlope(player.x,player.y);
    const terrainZ = getTerrainHeight(player.x,player.y);
    player.z = terrainZ;

    // Modify speed & physics based on slope
    const slopeEffect = -(slope.dx*Math.cos(player.angle) + slope.dy*Math.sin(player.angle))*0.1;
    player.speed += slopeEffect;

    // Movement
    player.x += Math.cos(player.angle)*player.speed;
    player.y += Math.sin(player.angle)*player.speed;

    // Bounds
    player.x = Math.max(0,Math.min(WORLD_SIZE,player.x));
    player.y = Math.max(0,Math.min(WORLD_SIZE,player.y));

    // Enhanced lean & sinking in powder
    const deepSnow = player.speed>2 ? 0.5 : 0;
    player.lean = Math.sin(player.angle)*0.5 + deepSnow*0.3;

    // Powder spray (ultra-realistic)
    if(Math.abs(player.speed)>1){
        const count = Math.floor(player.speed*2);
        for(let i=0;i<count;i++){
            const angleOffset = (Math.random()-0.5)*Math.PI/3 + Math.PI; // behind snowmobile
            const dist = Math.random()*4 + 2;
            powder.push({
                x: player.x + Math.cos(player.angle+angleOffset)*dist,
                y: player.y + Math.sin(player.angle+angleOffset)*dist,
                dx: Math.cos(angleOffset)*0.2,
                dy: Math.sin(angleOffset)*0.2,
                life: 20 + Math.random()*10
            });
        }
    }

    powder.forEach(p=>{
        p.x+=p.dx; p.y+=p.dy; p.life--;
    });
    for(let i=powder.length-1;i>=0;i--){
        if(powder[i].life<=0) powder.splice(i,1);
    }

    // Snowflakes
    snowflakes.forEach(f=>{
        f.x+=f.dx; f.y+=f.dy;
        if(f.y>canvas.height) f.y=0;
        if(f.x<0) f.x=canvas.width;
        if(f.x>canvas.width) f.x=0;
    });
}

/* ================= DRAW ================= */
function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const night = (Math.sin(timeOfDay)+1)/2;

    // Sky
    const skyColor = night>0.5?"#a0d8ff":"#0a1b2c";
    ctx.fillStyle=skyColor;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // Sun
    if(night>0.5){
        ctx.fillStyle="#fff59d";
        ctx.beginPath();
        ctx.arc(400,50,20,0,Math.PI*2);
        ctx.fill();
    }

    // Terrain pseudo-3D
    const viewOffsetX = canvas.width/2 - player.x;
    const viewOffsetY = canvas.height/2 - player.y;

    for(let gx=0;gx<terrain.length;gx++){
        for(let gy=0;gy<terrain[0].length;gy++){
            const h = terrain[gx][gy];
            const px = gx*GRID + viewOffsetX;
            const py = gy*GRID + viewOffsetY - h*0.5;
            if(px<0||px>canvas.width||py<0||py>canvas.height) continue;
            const shade = 180 - h;
            ctx.fillStyle=`rgb(${shade},${shade},255)`;
            ctx.fillRect(px,py,GRID,GRID);
        }
    }

    // Trees
    trees.forEach(t=>{
        const px = t.x + viewOffsetX;
        const py = t.y + viewOffsetY - getTerrainHeight(t.x,t.y)*0.5;
        if(px<0||px>canvas.width||py<0||py>canvas.height) return;
        ctx.fillStyle="rgba(0,0,0,0.3)";
        ctx.fillRect(px+2,py+4,6,3);
        ctx.fillStyle="#5a3b1a";
        ctx.fillRect(px+3,py,2,t.h);
        ctx.fillStyle=t.color;
        ctx.beginPath();
        ctx.moveTo(px-2,py);
        ctx.lineTo(px+6,py);
        ctx.lineTo(px+2,py-4);
        ctx.closePath();
        ctx.fill();
        if(t.snowCap){
            ctx.fillStyle="rgba(255,255,255,0.7)";
            ctx.fillRect(px,py-4,4,2);
        }
    });

    // Powder
    ctx.fillStyle="rgba(255,255,255,0.9)";
    powder.forEach(p=>{
        const px = p.x + viewOffsetX;
        const py = p.y + viewOffsetY - getTerrainHeight(p.x,p.y)*0.5;
        ctx.fillRect(px,py,1,1);
    });

    // Snowmobile
    const cx = canvas.width/2;
    const cy = canvas.height/2 - player.z*0.5;
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(player.angle);

    // Skis
    ctx.fillStyle="#222222";
    ctx.fillRect(-5,-5,2,12);
    ctx.fillRect(3,-5,2,12);

    // Hood/body
    ctx.fillStyle="#c40000";
    ctx.beginPath();
    ctx.moveTo(-6,-5);
    ctx.lineTo(6,-5);
    ctx.lineTo(4,5);
    ctx.lineTo(-4,5);
    ctx.closePath();
    ctx.fill();

    // Driver
    ctx.fillStyle="#555555";
    ctx.fillRect(-2,-10,4,5);

    ctx.restore();

    // Headlight
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(player.angle);
    ctx.fillStyle="rgba(255,255,200,0.15)";
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo(50,-25);
    ctx.lineTo(50,25);
    ctx.closePath();
    ctx.fill();
    ctx.restore();

    // Snowflakes
    ctx.fillStyle="rgba(255,255,255,0.9)";
    snowflakes.forEach(f=>ctx.fillRect(f.x,f.y,f.size,f.size));

    // Mini-map
    ctx.fillStyle="#000000aa";
    ctx.fillRect(canvas.width-62,2,60,60);
    for(let gx=0;gx<terrain.length;gx+=4){
        for(let gy=0;gy<terrain[0].length;gy+=4){
            const h = terrain[gx][gy];
            const px = canvas.width-62 + gx/terrain.length*60;
            const py = 2 + gy/terrain[0].length*60;
            const shade = 150 - h;
            ctx.fillStyle=`rgb(${shade},${shade},${shade})`;
            ctx.fillRect(px,py,1,1);
        }
    }
    trees.forEach(t=>{
        const px = canvas.width-62 + t.x/WORLD_SIZE*60;
        const py = 2 + t.y/WORLD_SIZE*60;
        ctx.fillStyle="#fff";
        ctx.fillRect(px,py,1,1);
    });
    ctx.fillStyle="#ff0000";
    ctx.fillRect(canvas.width-62 + player.x/WORLD_SIZE*60, 2 + player.y/WORLD_SIZE*60,2,2);

    // Compass
    ctx.save();
    ctx.translate(canvas.width-32,70);
    ctx.rotate(player.angle);
    ctx.fillStyle="#fff";
    ctx.beginPath();
    ctx.moveTo(0,-6);
    ctx.lineTo(2,2);
    ctx.lineTo(-2,2);
    ctx.closePath();
    ctx.fill();
    ctx.restore();

    // Night overlay
    if(night<0.4){
        ctx.fillStyle="rgba(0,20,40,0.25)";
        ctx.fillRect(0,0,canvas.width,canvas.height);
    }
}

/* ================= LOOP ================= */
function loop(){
    update();
    draw();
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
