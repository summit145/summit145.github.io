using UnityEngine;
using UnityEngine.UI;

// ===================== PLAYER CONTROLLER =====================
public class PlayerController : MonoBehaviour
{
    [Header("Movement")]
    public float moveSpeed = 5f;
    public Rigidbody2D rb;
    public Joystick joystick; // Mobile joystick

    [Header("Weapons")]
    public Weapon[] weapons;
    public int currentWeaponIndex = 0;
    private Weapon currentWeapon;

    [Header("Camera & Targeting")]
    public Camera cam;
    private Vector2 movement;
    private Vector2 mousePos;

    [Header("Health")]
    public PlayerHealth healthSystem;

    void Start()
    {
        if (weapons.Length > 0)
        {
            currentWeapon = weapons[currentWeaponIndex];
        }
    }

    void Update()
    {
        // --- Movement ---
#if UNITY_EDITOR || UNITY_STANDALONE
        movement.x = Input.GetAxisRaw("Horizontal");
        movement.y = Input.GetAxisRaw("Vertical");
        mousePos = cam.ScreenToWorldPoint(Input.mousePosition);
#else
        movement.x = joystick.Horizontal;
        movement.y = joystick.Vertical;
        mousePos = cam.ScreenToWorldPoint(Input.mousePosition); // Optional aim
#endif

        // --- Shooting ---
        if (Input.GetButton("Fire1") || Input.touchCount > 0)
            currentWeapon.Shoot(mousePos);

        // --- Reload ---
        if (Input.GetKeyDown(KeyCode.R))
            currentWeapon.Reload();

        // --- Weapon Switching ---
        if (Input.GetKeyDown(KeyCode.Q))
        {
            currentWeaponIndex = (currentWeaponIndex + 1) % weapons.Length;
            currentWeapon = weapons[currentWeaponIndex];
        }
    }

    void FixedUpdate()
    {
        rb.MovePosition(rb.position + movement * moveSpeed * Time.fixedDeltaTime);

        Vector2 lookDir = mousePos - rb.position;
        float angle = Mathf.Atan2(lookDir.y, lookDir.x) * Mathf.Rad2Deg - 90f;
        rb.rotation = angle;
    }
}

// ===================== PLAYER HEALTH =====================
public class PlayerHealth : MonoBehaviour
{
    public int maxHealth = 100;
    public int currentHealth;
    public Slider healthBar;

    void Start()
    {
        currentHealth = maxHealth;
        healthBar.value = currentHealth;
    }

    public void TakeDamage(int damage)
    {
        currentHealth -= damage;
        healthBar.value = currentHealth;

        if (currentHealth <= 0)
            Die();
    }

    void Die()
    {
        Debug.Log("Player Dead!");
        // TODO: Add respawn or game over logic
    }
}

// ===================== WEAPON SYSTEM =====================
[System.Serializable]
public class Weapon : MonoBehaviour
{
    public string weaponName;
    public int ammo = 30;
    public int maxAmmo = 30;
    public float fireRate = 0.2f;
    public GameObject bulletPrefab;
    public Transform firePoint;

    public bool isAutomatic = true;
    public float bulletSpeed = 20f;

    private float nextFireTime = 0f;

    public void Shoot(Vector2 target)
    {
        if (Time.time < nextFireTime || ammo <= 0) return;

        GameObject bullet = GameObject.Instantiate(bulletPrefab, firePoint.position, firePoint.rotation);
        Vector2 dir = (target - (Vector2)firePoint.position).normalized;
        bullet.GetComponent<Rigidbody2D>().velocity = dir * bulletSpeed;

        ammo--;
        nextFireTime = Time.time + fireRate;
    }

    public void Reload()
    {
        ammo = maxAmmo;
    }
}

// ===================== BULLET =====================
public class Bullet : MonoBehaviour
{
    public int damage = 10;
    public float lifetime = 2f;

    void Start()
    {
        Destroy(gameObject, lifetime);
    }

    void OnTriggerEnter2D(Collider2D collision)
    {
        if (collision.CompareTag("Enemy"))
        {
            collision.GetComponent<Enemy>().TakeDamage(damage);
            Destroy(gameObject);
        }
    }
}

// ===================== ENEMY AI =====================
public class Enemy : MonoBehaviour
{
    public float moveSpeed = 3f;
    public int health = 50;
    public Transform target;
    public float shootingRange = 5f;
    public float fireRate = 1f;
    public GameObject bulletPrefab;
    public Transform firePoint;

    private float nextFireTime = 0f;

    void Update()
    {
        if (target == null) return;

        Vector2 dir = (target.position - transform.position).normalized;
        transform.position += (Vector3)dir * moveSpeed * Time.deltaTime;

        float angle = Mathf.Atan2(dir.y, dir.x) * Mathf.Rad2Deg - 90f;
        transform.rotation = Quaternion.Euler(0, 0, angle);

        float distance = Vector2.Distance(transform.position, target.position);
        if (distance <= shootingRange)
        {
            ShootAtPlayer();
        }
    }

    void ShootAtPlayer()
    {
        if (Time.time < nextFireTime) return;
        GameObject bullet = Instantiate(bulletPrefab, firePoint.position, firePoint.rotation);
        Vector2 dir = (target.position - firePoint.position).normalized;
        bullet.GetComponent<Rigidbody2D>().velocity = dir * 15f;
        nextFireTime = Time.time + fireRate;
    }

    public void TakeDamage(int damage)
    {
        health -= damage;
        if (health <= 0) Destroy(gameObject);
    }
}

// ===================== PICKUPS =====================
public class Pickup : MonoBehaviour
{
    public enum PickupType { Ammo, Health, Grenade }
    public PickupType pickupType;
    public int value = 20;

    void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            var player = other.GetComponent<PlayerController>();
            var health = other.GetComponent<PlayerHealth>();

            switch (pickupType)
            {
                case PickupType.Ammo:
                    if (player.currentWeapon != null)
                        player.currentWeapon.ammo += value;
                    break;
                case PickupType.Health:
                    health.currentHealth += value;
                    if (health.currentHealth > health.maxHealth)
                        health.currentHealth = health.maxHealth;
                    health.healthBar.value = health.currentHealth;
                    break;
                case PickupType.Grenade:
                    // TODO: Add grenade logic
                    break;
            }
            Destroy(gameObject);
        }
    }
}

// ===================== GRENADE (BASIC) =====================
public class Grenade : MonoBehaviour
{
    public float delay = 2f;
    public float blastRadius = 3f;
    public int damage = 50;

    void Start()
    {
        Invoke("Explode", delay);
    }

    void Explode()
    {
        Collider2D[] hitEnemies = Physics2D.OverlapCircleAll(transform.position, blastRadius);
        foreach (var enemy in hitEnemies)
        {
            if (enemy.CompareTag("Enemy"))
                enemy.GetComponent<Enemy>().TakeDamage(damage);
        }
        Destroy(gameObject);
    }

    void OnDrawGizmosSelected()
    {
        Gizmos.color = Color.red;
        Gizmos.DrawWireSphere(transform.position, blastRadius);
    }
}
